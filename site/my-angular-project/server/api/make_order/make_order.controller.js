/**
 * Using Rails-like standard naming convention for endpoints.
 * GET     /things              ->  index
 * POST    /things              ->  create
 * GET     /things/:id          ->  show
 * PUT     /things/:id          ->  update
 * DELETE  /things/:id          ->  destroy
 */

'use strict';

var _ = require('lodash');
var express = require('express');
var async = require('async');
var Web3 = require('web3');
var makePromise2 = require('../deferred');
var Settings = require('../settings');
var settings = new Settings();
var Base64 = require('../base64');
var base64 = new Base64();

//var web3provider = typeof(web3) !== 'undefined' ? web3.currentProvider : new Web3.providers.HttpProvider(settings.web3provider);
var web3provider = new Web3.providers.HttpProvider(settings.web3provider);
var web3 = new Web3(web3provider);

var hashFnv32a = function(str, asString, seed) {
    /*jshint bitwise:false */
    var i, l,
        hval = (seed === undefined) ? 0x811c9dc5 : seed;

    for (i = 0, l = str.length; i < l; i++) {
        hval ^= str.charCodeAt(i);
        hval += (hval << 1) + (hval << 4) + (hval << 7) + (hval << 8) + (hval << 24);
    }
    if( asString ){
        // Convert to 8 digit hex string
        return ("0000000" + (hval >>> 0).toString(16)).substr(-8);
    }
    return hval >>> 0;
};

var getHash = function(value) {
  //var hash = $scope.web3.sha3(value);
  var hash = hashFnv32a(value, false);
  return hash;
};

var checkArguments = function(input, keywords) {
  for(var i = 0; i < keywords.length; i++) {
    if(typeof(input[keywords[i][0]]) != keywords[i][1]) {
      throw "Wrong input data: type of '" + keywords[i][0] +
       "' is not a '" + keywords[i][1] + "'";
    }
  }
}

exports.index = async function(req, res) {
  var props = _.merge(req.body, req.params, req.query);
  var data = props['data'];
  //var data = "ew0KICAiY3VzdG9tZXIiOiB7DQogICAgImFjY291bnQiOiAiMHhjY2E3NWJlNmEyMGUyMjg4YTEzMDUxMTk3MzAyNzc4M2FkY2M0ZTUzIiwNCiAgICAicGFzc3dvcmQiOiAiIg0KICB9LA0KICAidHJpcHMiOiBbDQogICAgew0KICAgICAgImNhcnJpZXIiOiAiMHhjY2E3NWJlNmEyMGUyMjg4YTEzMDUxMTk3MzAyNzc4M2FkY2M0ZTUzIiwNCiAgICAgICJwcmljZSI6ICIxMDA1MDAiLA0KICAgICAgInBpY2t1cCI6IHsNCiAgICAgICAgImFkZHJlc3MiOiAi0JzQvtGB0LrQstCwIiwNCiAgICAgICAgImRhdGUiOiAiMTUyMjQyNjc5OTYxNCIsDQogICAgICAgICJjYXJnbyI6IHsNCiAgICAgICAgICAibmFtZSI6ICLQkNGA0LHRg9C30YsiLA0KICAgICAgICAgICJhbW91bnQiOiAxMCwNCiAgICAgICAgICAidW5pdHMiOiAi0LrQuNC70L7RgtC+0L3QvdGLIg0KICAgICAgICB9DQogICAgICB9LA0KICAgICAgImRyb3Bkb3duIjogew0KICAgICAgICAiYWRkcmVzcyI6ICLQo9GA0Y7Qv9C40L3RgdC6IiwNCiAgICAgICAgImRhdGUiOiAiMTUyMjQyNjc5OTYxNCIsDQogICAgICAgICJjYXJnbyI6IHsNCiAgICAgICAgICAibmFtZSI6ICLQmtC+0YDQutC4INC+0YIg0LDRgNCx0YPQt9C+0LIiLA0KICAgICAgICAgICJhbW91bnQiOiA1LA0KICAgICAgICAgICJ1bml0cyI6ICLQutC40LvQvtGC0L7QvdC90YsiDQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9DQogIF0NCn0=";
  if(typeof(data) == 'undefined') {
    res.json({
      status: 'ERROR: data argument is undefined'
    });
    return;
  }

  try {
    var jsonData = base64.decode(data);
    var input = JSON.parse(jsonData);

    checkArguments(input, [["customer", "object"], ["trips", "object"]]);
    checkArguments(input.customer, [["account", "string"], ["password", "string"]]);
    checkArguments(input.trips[0], [
                            ["carrier", "string"],
                            ["price", "string"],
                            ["pickup", "object"],
                            ["dropdown", "object"]]);
    checkArguments(input.trips[0].pickup, [
                            ["address", "string"],
                            ["date", "string"],
                            ["cargo", "object"]]);
    checkArguments(input.trips[0].pickup.cargo, [
                            ["name", "string"],
                            ["amount", "number"],
                            ["units", "string"]]);
    checkArguments(input.trips[0].dropdown, [
                            ["address", "string"],
                            ["date", "string"],
                            ["cargo", "object"]]);
    checkArguments(input.trips[0].dropdown.cargo, [
                            ["name", "string"],
                            ["amount", "number"],
                            ["units", "string"]]);
   var platformJsonData = base64.decode(settings.platformJsonB64);
   var platformProto = JSON.parse(platformJsonData);
   var contract = await web3.eth.contract(platformProto);
   var platform = await contract.at(settings.platformAddress);

   await makePromise2(web3.personal.unlockAccount, [input.customer.account, input.customer.password]);


   var trackHashes = [];
   var trackAddress = [];
   var trackPrices = [];
   for(var i = 0; i < input.trips.length; i++) {
      var item = input.trips[i];
      trackHashes.push(getHash(item.pickup.address));  // pickup.location
      trackHashes.push(getHash(item.pickup.date.toString()));  // pickup.date
      trackHashes.push(getHash(JSON.stringify(item.pickup.cargo)));  // pickup.description
      trackHashes.push(getHash(item.dropdown.address));  // dropdown.location
      trackHashes.push(getHash(item.dropdown.date.toString()));  // dropdown.date
      trackHashes.push(getHash(JSON.stringify(item.dropdown.cargo)));  // dropdown.description
      trackHashes.push(getHash(new Date().toString()));  // assignment.date (.getTime() needed??)
      trackHashes.push(getHash('shit'));  // assignment.proof (BUG - implemented in future)
      trackAddress.push(item.carrier); // carrier
      trackPrices.push(item.price); // price in microCC
    }
    // pack arguments into arrays

/*    var transactionHash = await makePromise2(platform.addOrder, [input.customer.account,
      trackHashes, trackAddress, trackPrices, settings.cargoCoinAddress,
      {from:input.customer.account, to:settings.platformAddress, gas:3000000 }]);
    // deploy new order */

    var abi = base64.decode(settings.orderJsonb64);
    var bin = '0x6060604052341561000f57600080fd5b604051610d00380380610d008339810160405280805191906020018051919060200180518201919060200180518201919060200180518201919060200180519150505b600080600061005f610474565b610067610474565b61006f610494565b60008054600160a060020a03338116600160a060020a0319928316178355600780548b831690841617905560088054309092169190921617905560018d815560028054909160ff1990911690835b02179055506002805461010060a860020a031916610100600160a060020a038e1602179055600095508594508493505b875184101561045d578360080295506060604051908101604052808b888151811061011457fe5b9060200190602002015163ffffffff1681526020018b886001018151811061013857fe5b9060200190602002015163ffffffff1681526020018b886002018151811061015c57fe5b9060200190602002015163ffffffff16905292506060604051908101604052808b886003018151811061018b57fe5b9060200190602002015163ffffffff1681526020018b88600401815181106101af57fe5b9060200190602002015163ffffffff1681526020018b88600501815181106101d357fe5b9060200190602002015163ffffffff169052915060408051908101604052808b886006018151811061020157fe5b9060200190602002015163ffffffff1681526020018b886007018151811061022557fe5b9060200190602002015163ffffffff169052905060c06040519081016040528060005b81526020018481526020018381526020018a868151811061026557fe5b90602001906020020151600160a060020a0316815260200182815260200189868151811061028f57fe5b906020019060200201519052600454600090815260066020526040902081518154829060ff191660018360038111156102c457fe5b02179055506020820151600182018151815463ffffffff191663ffffffff919091161781556020820151815463ffffffff919091166401000000000267ffffffff00000000199091161781556040820151815463ffffffff919091166801000000000000000002604060020a63ffffffff0219909116179055506040820151600282018151815463ffffffff191663ffffffff919091161781556020820151815463ffffffff919091166401000000000267ffffffff00000000199091161781556040820151815463ffffffff919091166801000000000000000002604060020a63ffffffff0219909116179055506060820151600382018054600160a060020a031916600160a060020a03929092169190911790556080820151600482018151815463ffffffff191663ffffffff919091161781556020820151815463ffffffff919091166401000000000267ffffffff00000000199091161790555060a08201516005909101555087848151811061043a57fe5b90602001906020020151600480546001019055909401935b6001909301926100ed565b60038590555b5050505050505050505050506104ab565b606060405190810160409081526000808352602083018190529082015290565b604080519081016040526000808252602082015290565b610846806104ba6000396000f3006060604052361561009e5763ffffffff60e060020a60003504166313af403581146100a35780631bce6ff3146100c45780632095b823146100f05780632804b2c014610115578063522e117714610144578063629058ca1461017b578063a035b1fe14610201578063ab1daaa614610226578063b3cea2171461024b578063c19d93fb14610270578063d36dedd2146102a7578063ea8a1af01461030c575b600080fd5b34156100ae57600080fd5b6100c2600160a060020a0360043516610343565b005b6100cc61038b565b604051808260068111156100dc57fe5b60ff16815260200191505060405180910390f35b34156100fb57600080fd5b610103610481565b60405190815260200160405180910390f35b341561012057600080fd5b610128610487565b604051600160a060020a03909116815260200160405180910390f35b341561014f57600080fd5b6100cc61049b565b604051808260068111156100dc57fe5b60ff16815260200191505060405180910390f35b341561018657600080fd5b6101916004356105e2565b604051808a60038111156101a157fe5b60ff168152600160a060020a0390991660208a01525060408089019790975263ffffffff9586166060890152938516608088015291841660a0870152831660c0860152821660e08501521661010083015261012090910191505180910390f35b341561020c57600080fd5b610103610681565b60405190815260200160405180910390f35b341561023157600080fd5b610103610687565b60405190815260200160405180910390f35b341561025657600080fd5b61010361068d565b60405190815260200160405180910390f35b341561027b57600080fd5b610283610693565b604051808260058111156100dc57fe5b60ff16815260200191505060405180910390f35b34156102b257600080fd5b6102ba61069c565b604051808660058111156102ca57fe5b60ff16815260200185600160a060020a0316600160a060020a031681526020018481526020018381526020018281526020019550505050505060405180910390f35b341561031757600080fd5b6100cc6106c6565b604051808260068111156100dc57fe5b60ff16815260200191505060405180910390f35b60005433600160a060020a0390811691161461035e57600080fd5b6000805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a0383161790555b5b50565b60025460009033600160a060020a0390811661010090920416141561047c5760005b60025460ff1660058111156103be57fe5b141561047c57600754600854600354600160a060020a03928316926323b872dd92339291169060006040516020015260405160e060020a63ffffffff8616028152600160a060020a0393841660048201529190921660248201526044810191909152606401602060405180830381600087803b151561043c57600080fd5b6102c65a03f1151561044d57600080fd5b5050506040518051151560011490506104685750600561047c565b60028054819060ff19166001825b02179055505b5b5b90565b60045481565b6002546101009004600160a060020a031681565b6000808060025b60025460ff1660058111156104b357fe5b146104c157600192506105dd565b60025433600160a060020a039081166101009092041614156105d857506001905060005b6004548110156105ba576007546000828152600660205260408082206003810154600590910154600160a060020a039485169463513553629492169290918791516020015260405160e060020a63ffffffff8616028152600160a060020a03909316600484015260248301919091526044820152606401602060405180830381600087803b151561057557600080fd5b6102c65a03f1151561058657600080fd5b50505060405180515050600081815260066020526040902080546002919060ff19166001835b02179055505b6001016104e5565b600280546003919060ff19166001835b0217905550600092506105dd565b600392505b505090565b60008060008060008060008060006004548a1015156105fd57fe5b50505060008781526006602052604090208054600382015460058301546001840154600285015460049095015460ff9094169a50600160a060020a039092169850965063ffffffff808216965068010000000000000000918290048116955083811694509204821691818116916401000000009004165b9193959799909294969850565b60035481565b60055481565b60015481565b60025460ff1681565b60025460035460045460055460ff8416936101009004600160a060020a03169291905b9091929394565b600254600090819033600160a060020a0390811661010090920416141561081157600754600854600160a060020a03918216916370a08231911660006040516020015260405160e060020a63ffffffff8416028152600160a060020a039091166004820152602401602060405180830381600087803b151561074757600080fd5b6102c65a03f1151561075857600080fd5b505050604051805191505060008111156107f357600754600254600160a060020a039182169163a9059cbb916101009004168360006040516020015260405160e060020a63ffffffff8516028152600160a060020a0390921660048301526024820152604401602060405180830381600087803b15156107d757600080fd5b6102c65a03f115156107e857600080fd5b505050604051805150505b600280546004919060ff19166001835b021790555060009150610816565b600691505b50905600a165627a7a72305820dda85bafa7429ce52d710b5b8d26b0db80b8e9c79e977356aaf691c206dfcb110029';
    var orderProxy = web3.eth.contract(JSON.parse(abi));

    var contract = orderProxy.new(0, input.customer.account,
          trackHashes, trackAddress, trackPrices, settings.cargoCoinAddress,
          {from:input.customer.account, gas:3000000, gasPrice:"20000000000", data: bin});

//    web3.personal.lockAccount(input.customer.account);

    res.json({
      status: 'OK',
      tx: contract.transactionHash
    });
  }
  catch(e) {
    console.log(e);
    res.json({
      status: 'ERROR: ' + e.toString()
    });
  };
};
